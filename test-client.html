<!doctype html>
<html>
  <head>
    <title>Chat Test Client</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
  </head>
  <body>
    <h1>Chat Test Client</h1>

    <div>
      <input type="text" id="room" placeholder="Room Name" value="default" />
      <input type="text" id="message" placeholder="Message" />
      <button onclick="sendMessage()">Send Message</button>
    </div>

    <div id="messages"></div>

    <script>
      const socket = io("http://localhost:3000", {
        auth: {
          token: localStorage.getItem("accessToken"),
        },
      });

      socket.on("connect", () => {
        console.log("Connected to server");
        document.getElementById("messages").innerHTML +=
          "<p>Connected to server</p>";
      });

      socket.on("chat:message", (message) => {
        console.log("Received message:", message);
        document.getElementById("messages").innerHTML +=
          `<p><strong>${message.sender}:</strong> ${message.content}</p>`;
      });

      socket.on("error", (error) => {
        console.error("Socket error:", error);
        document.getElementById("messages").innerHTML +=
          `<p style="color: red;">Error: ${error.message}</p>`;
      });

      socket.on("new_message", (message) => {
        console.log("Received message:", message);
        document.getElementById("messages").innerHTML +=
          `<p><strong>${message.sender}:</strong> ${message.content}</p>`;
      });

      socket.on("connect_error", async (error) => {
        if (error.message === "Unauthorized") {
          const success = await refreshToken();
          if (!success) {
            window.location.href = "/login.html";
          }
        }
      });

      function sendMessage() {
        const room = document.getElementById("room").value;
        const message = document.getElementById("message").value;

        if (!message) {
          alert("Please enter a message");
          return;
        }

        const payload = {
          message: message,
          room: room,
        };

        console.log("Sending payload:", payload);
        socket.emit("chat:message", payload);

        // Clear message input
        document.getElementById("message").value = "";
      }
    </script>
  </body>
</html>
